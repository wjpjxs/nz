# ⭐ 新手保姆级教程 · Hugging Face 部署哪吒面板 V1

> ⚠️ **安全提示**
> 本方案 **未使用 OAuth 登录**
> **第一次登录面板后必须立刻修改默认账号密码**

---

## 一、最终效果

完成部署后，你将拥有：

* ✅ 哪吒监控面板（可监控多台服务器状态）
* ✅ 通过 Cloudflare Tunnel 安全访问（不暴露真实 IP）
* ✅ 自动备份配置到 GitHub（防止数据丢失）
* ✅ Hugging Face 提供运行环境，**完全免费，无需服务器**

---

## 二、准备工作

### 2.1 需要注册的账号

| 平台 | 网址 | 用途 |
|------|------|------|
| GitHub | https://github.com | 存放代码、构建镜像、备份数据 |
| Cloudflare | https://dash.cloudflare.com | 提供域名和安全隧道 |
| Hugging Face | https://huggingface.co | 运行 Docker 容器 |

> 💡 没有就先注册，每个平台 5 分钟就能完成

### 2.2 需要提前准备的东西

| 名称 | 说明 | 如何获取 |
|------|------|----------|
| 一个域名 | 用于访问面板 | 在 Cloudflare 添加（可以是免费域名或已有域名） |
| GitHub 备份仓库 | 用于存放备份文件 | 需要提前在 GitHub 创建一个**空仓库** |

### 2.3 创建 GitHub 备份仓库

1. 登录 GitHub
2. 点击右上角 **+** → **New repository**
3. 填写仓库名（例如：`nezha-backup`）
4. 选择 **Private**（私有，推荐）
5. ✅ 勾选 **Add a README file**
6. 点击 **Create repository**

> 📝 记下你的：
> - GitHub 用户名（例如：`zhangsan`）
> - 备份仓库名（例如：`nezha-backup`）

### 2.4 生成 GitHub Token

1. 点击 GitHub 右上角头像 → **Settings**
2. 左侧最下方 → **Developer settings**
3. 左侧 → **Personal access tokens** → **Tokens (classic)**
4. 点击 **Generate new token** → **Generate new token (classic)**
5. 填写：
   - **Note**：`nezha-backup`（随便写，用于标识）
   - **Expiration**：选择 **No expiration**（永不过期）
   - **权限勾选**：
     - ✅ `repo`（全选）
     - ✅ `write:packages`
     - ✅ `read:packages`
6. 点击 **Generate token**
7. **立即复制并保存 Token**（只显示一次！）

> ⚠️ 这个 Token 格式类似：`ghp_xxxxxxxxxxxxxxxxxxxx`

> 💡 **关于 Token 有效期**：
> - 选择 **No expiration** 可以避免 Token 过期导致备份失败
> - 如果担心安全问题，也可以设置较长期限（如 1 年），但需要记得到期前更新

### 2.5 生成 NZ_UUID

UUID 是 Agent 的唯一标识符，你可以：

**方法一：在线生成**
- 访问 https://www.uuidgenerator.net/
- 复制生成的 UUID（格式如：`550e8400-e29b-41d4-a716-446655440000`）

**方法二：命令行生成**
```bash
# Linux/Mac
uuidgen

# 或使用 Python
python -c "import uuid; print(uuid.uuid4())"
```

> 📝 保存好这个 UUID，后面要用

---

## 三、Fork 项目

### 3.1 打开原项目

访问原项目仓库：**[https://github.com/oyz8/nz]**

### 3.2 Fork 到自己账号

1. 点击页面右上角的 **Fork** 按钮
2. 在弹出页面中：
   - **Owner**：选择你自己的账号
   - **Repository name**：保持默认或自定义
   - ❌ 不要勾选 "Copy the main branch only"
3. 点击 **Create fork**
4. 等待几秒，页面会跳转到你自己的仓库

> ✅ 成功标志：地址栏显示 `github.com/你的用户名/项目名`

### 3.3 为什么要 Fork？

| 原因 | 说明 |
|------|------|
| Docker 镜像由你自己构建 | 确保代码安全可控 |
| 备份推送到你自己的仓库 | 数据完全属于你 |
| 可以自定义修改 | 方便后续维护 |

---

## 四、启用 GitHub Actions（构建 Docker 镜像）

### 4.1 启用 Actions

1. 进入你 Fork 后的仓库
2. 点击顶部菜单栏的 **Actions**
3. 看到黄色提示框，点击 **I understand my workflows, go ahead and enable them**

### 4.2 手动触发构建

1. 在左侧找到工作流列表
2. 点击：**🐳 构建自己的镜像吧**（或类似名称的 workflow）
3. 点击右侧 **Run workflow**
4. 在弹出的表单中填写：

| 参数 | 填写内容 | 说明 |
|------|----------|------|
| **Use workflow from** | `main`（默认） | 选择分支，保持默认即可 |
| **镜像名称** | `nz` | 自定义镜像名称 |
| **镜像标签** | `latest`（默认） | 镜像版本标签，保持默认即可 |

5. 点击绿色的 **Run workflow** 按钮

> 📝 **示例**：
> - 如果你的 GitHub 用户名是 `zhangsan`，镜像名称填 `nz`
> - 构建完成后，镜像地址就是：`ghcr.io/zhangsan/nz:latest`

> 💡 **提示**：
> - 镜像名称只能使用**小写字母、数字、短横线（-）**
> - 不要使用中文或特殊字符
> - 记住你填写的镜像名称，后面创建 Dockerfile 时要用

### 4.3 等待构建完成

1. 点击正在运行的 workflow 查看进度
2. 等待所有步骤变成 ✅ 绿色勾
3. 构建时间通常 3-10 分钟

> ❌ 如果构建失败（红色 ✗）：
> - 点击查看错误日志
> - 常见原因：Token 权限不足、网络问题
> - 可以点击 **Re-run all jobs** 重试

---

## 五、获取 Docker 镜像地址

### 5.1 查看构建好的镜像

1. 回到你 Fork 的仓库主页
2. 在右侧边栏找到 **Packages**
3. 点击进入

### 5.2 复制镜像地址

1. 找到名为 `nz` 的 Package
2. 镜像地址格式为：

```
ghcr.io/你的GitHub用户名/nz:latest
```

> 📝 **示例**：如果你的用户名是 `zhangsan`，则地址为：
> `ghcr.io/zhangsan/nz:latest`

---

## 六、配置 Cloudflare Tunnel

### 6.1 进入 Zero Trust 面板

1. 登录 https://dash.cloudflare.com
2. 左侧菜单找到 **Zero Trust**（或点击顶部的 Zero Trust 入口）
3. 首次使用需要设置团队名（随便填一个）

### 6.2 创建 Tunnel

1. 左侧菜单：**Networks** → **Tunnels**
2. 点击 **Create a tunnel**
3. 选择 **Cloudflared** → **Next**
4. 填写 Tunnel 名称（例如：`nezha-panel`）→ **Save tunnel**

### 6.3 获取 Tunnel Token

在 "Install and run a connector" 页面：

1. 选择 **Docker** 选项
2. 找到命令中的 Token（很长的一串字符）
3. **复制并保存**

```bash
# 命令类似这样，eyJ 开头的就是 Token
docker run cloudflare/cloudflared:latest tunnel --no-autoupdate run --token eyJhIjoixxxxxx...
```

> 📝 这个就是 **`ARGO_AUTH`**

### 6.4 配置 Public Hostname

点击 **Next** 进入 Public Hostname 配置：

| 配置项 | 填写内容 |
|--------|----------|
| Subdomain | `nezha`（或你喜欢的前缀） |
| Domain | 选择你在 Cloudflare 的域名 |
| Type | **HTTPS** |
| URL | `localhost:443` |

展开 **Additional application settings** → **TLS**：
- ✅ **No TLS Verify**：开启
- ✅ **HTTP2 connection**：开启

点击 **Save tunnel**

> 📝 你的面板域名就是 **`前缀.你的域名`**（例如：`nezha.example.com`）
> 这个就是 **`ARGO_DOMAIN`**

### 6.5 开启域名的 gRPC 支持

1. 回到 Cloudflare 主面板（点击左上角 Cloudflare 图标）
2. 点击你的域名进入管理
3. 左侧菜单：**Network**
4. 找到 **gRPC**，开启它

> ⚠️ 这步很重要！不开启 gRPC，Agent 无法正常通信

### 6.6 确认已获取的信息

到这里你应该有：

| 变量名 | 示例值 | 说明 |
|--------|--------|------|
| ARGO_AUTH | `eyJhIjoixxxxxxx...` | Tunnel Token |
| ARGO_DOMAIN | `nezha.example.com` | 面板访问域名 |

---

## 七、创建 Hugging Face Space

### 7.1 创建 Space

1. 登录 https://huggingface.co
2. 点击右上角头像 → **New Space**
3. 填写信息：
   - **Space name**：`nezha`（或其他名称）
   - **License**：随意选择
   - **Select the Space SDK**：选择 **Docker**
   - **Space hardware**：选择 **CPU basic - 2 vCPU - 16 GB - FREE**
   - **Visibility**：建议选择 **Private**
4. 点击 **Create Space**

### 7.2 进入 Space 设置

创建完成后，点击 **Settings** 标签页。

---

## 八、填写 Hugging Face 环境变量

### 8.1 添加环境变量

在 **Settings** 页面，找到 **Repository secrets** 区域。

点击 **New secret**，逐个添加以下变量：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `ARGO_AUTH` | 你的 Tunnel Token | 从 Cloudflare 复制 |
| `ARGO_DOMAIN` | 你的面板域名 | 例如 `nezha.example.com` |
| `GITHUB_TOKEN` | 你的 GitHub Token | `ghp_xxx` 格式 |
| `GITHUB_REPO_OWNER` | 你的 GitHub 用户名 | 例如 `zhangsan` |
| `GITHUB_REPO_NAME` | 备份仓库名 | 例如 `nezha-backup` |
| `GITHUB_BRANCH` | `main` | 备份仓库分支 |
| `ZIP_PASSWORD` | 自己设一个密码 | 用于加密备份文件 |
| `NZ_UUID` | 你生成的 UUID | Agent 标识符 |
| `NZ_TLS` | `true` | 启用 TLS |
| `DASHBOARD_VERSION` | `v1.14.1` | 面板版本号 |

> ⚠️ **重要提醒**：
> - **暂时不要添加 `NZ_CLIENT_SECRET`**（后面会从备份获取）
> - 变量名必须**完全一致**（区分大小写）
> - 值**不要加引号或多余空格**

### 8.2 添加方法示例

每添加一个：
1. 点击 **New secret**
2. **Name** 填变量名（如 `ARGO_AUTH`）
3. **Value** 填对应的值
4. 点击 **Add**

重复以上步骤，直到所有变量添加完成。

---

## 九、添加 Dockerfile 并第一次部署

### 9.1 创建 Dockerfile

1. 回到 Space 的 **Files** 标签页
2. 点击 **+ Add file** → **Create a new file**
3. 文件名填：`Dockerfile`
4. 内容填写：

```dockerfile
FROM ghcr.io/你的GitHub用户名/nz:latest
```

> 📝 **示例**：`FROM ghcr.io/zhangsan/nz:latest`

5. 点击 **Commit new file to main**

### 9.2 等待部署完成

1. 切换到 **App** 标签页
2. 观察 **Building** 状态
3. 等待变成 **Running**（通常需要 3-5 分钟）

### 9.3 验证部署成功

1. 用浏览器访问 `https://你的ARGO_DOMAIN`（例如：`https://nezha.example.com`）
2. 应该能看到哪吒面板的登录页面

> ❌ 如果无法访问：
> - 检查 Tunnel 状态是否为 Healthy
> - 检查 Hugging Face Space 是否 Running
> - 等待 2-3 分钟再试

---

## 十、第一次手动触发备份

> ⚠️ **必须在面板第一次启动后执行**
> 这一步会生成 `NZ_CLIENT_SECRET`

### 10.1 为什么需要手动触发？

- 容器首次启动时会自动生成 Agent Secret
- 我们需要把这个 Secret 备份出来
- 否则 HF 重启后 Secret 会丢失

### 10.2 触发备份的方法

1. 打开你的 GitHub **备份仓库**（例如：`nezha-backup`）
2. 点击 `README.md` 文件
3. 点击右上角 **✏️ 铅笔图标**（编辑）
4. 将文件内容**全部删除**，替换为：

```
backup
```

5. 点击 **Commit changes**
6. 在弹出框中再次点击 **Commit changes**

### 10.3 等待备份完成

- 守护进程**每小时检查一次** README.md
- 发现内容为 `backup` 就会触发备份
- 最多等待 **1 小时**

### 10.4 确认备份成功

刷新备份仓库页面，看到新增文件即表示成功：
- 会有一个 `.zip` 格式的备份文件
- README.md 内容会被自动清空

---

## 十一、从备份获取并补填 `NZ_CLIENT_SECRET`

### 11.1 下载备份文件

1. 在备份仓库中找到 `.zip` 文件
2. 点击文件名 → **Download**

### 11.2 解压备份

使用你设置的 `ZIP_PASSWORD` 解压文件。

> 💡 Windows 用户推荐使用 7-Zip
> Mac 用户可以用系统自带的归档工具

### 11.3 找到 Secret

打开解压后的 `config.yaml` 文件，找到 `agent_secret_key`：

```yaml
admin_template: admin-dist
agent_secret_key: pXGhxrZltSuj83mr8hFktfWTrrHIQA7m   # ← 这就是 NZ_CLIENT_SECRET
avg_ping_count: 2
cover: 1
https: {}
ip_change_notification_group_id: 0
jwt_secret_key: qHWEkwZbBBlNIin1zNpmrrnPV
jwt_timeout: 1
language: en_US
listen_port: 8008
location: Asia/Shanghai
site_name: ""
tls: true
user_template: user-dist
```

### 11.4 复制 Secret 值

复制 `agent_secret_key:` 后面的值（示例中是 `pXGhxrZltSuj83mr8hFktfWTrrHIQA7m`）

### 11.5 添加到 Hugging Face

1. 回到 Hugging Face Space → **Settings**
2. 在 **Repository secrets** 中点击 **New secret**
3. 添加：
   - **Name**：`NZ_CLIENT_SECRET`
   - **Value**：刚才复制的值
4. 点击 **Add**

### 11.6 重启 Space

1. 在 Settings 页面找到 **Factory reboot**
2. 或者回到 App 页面，点击 **⋮** → **Restart**
3. 等待重新部署完成

> ✅ 现在 Agent 才会真正上线！

---

## 十二、第一次登录面板必做的事

### 12.1 登录面板

1. 访问 `https://你的ARGO_DOMAIN`
2. 使用默认账号登录：
   - **用户名**：`admin`
   - **密码**：`admin`（或查看项目文档确认）

### 12.2 立即修改密码！

1. 登录后点击右上角用户名
2. 进入 **个人设置** 或 **修改密码**
3. 设置一个强密码
4. 保存

> ⚠️ **不改密码 = 极不安全！任何人都能登录你的面板**

### 12.3 其他建议设置

- 修改面板名称
- 设置站点描述
- 配置告警通知（可选）

---

## 十三、添加被监控的服务器（Agent）

### 13.1 获取 Agent 安装命令

1. 在面板中点击 **服务器** → **添加服务器**
2. 填写服务器名称
3. 保存后会显示 Agent 安装命令

### 13.2 在被监控服务器上安装

SSH 登录到你要监控的服务器，执行面板提供的安装命令。

---

## 十四、常见问题排查

### 问题对照表

| 问题 | 可能原因 | 解决办法 |
|------|----------|----------|
| 面板打不开 | Tunnel 未生效 | 检查 Cloudflare Tunnel 状态 |
| 面板打开但显示错误 | HF 容器未运行 | 检查 Space 状态是否 Running |
| Agent 永远离线 | `NZ_CLIENT_SECRET` 不匹配 | 重新从备份获取正确的 Secret |
| Agent 安装后不显示 | UUID 不匹配 | 确认 `NZ_UUID` 配置正确 |
| 备份没有触发 | README 内容不对 | 确保内容只有 `backup` 一个词 |
| 解压备份失败 | 密码错误 | 使用正确的 `ZIP_PASSWORD` |
| HF 重启后数据丢失 | 未正确恢复备份 | 确保环境变量与备份一致 |

### 查看日志的方法

**Hugging Face 日志：**
1. 进入 Space → **Logs** 标签
2. 查看实时日志输出

**GitHub Actions 日志：**
1. 进入仓库 → **Actions**
2. 点击具体的 workflow run
3. 查看每个步骤的输出

---

## 十五、环境变量完整说明

| 变量名 | 必填 | 说明 | 示例值 |
|--------|------|------|--------|
| `ARGO_AUTH` | ✅ | Cloudflare Tunnel Token | `eyJhIjoixxxx...` |
| `ARGO_DOMAIN` | ✅ | 面板访问域名 | `nezha.example.com` |
| `GITHUB_TOKEN` | ✅ | GitHub 访问令牌 | `ghp_xxxx...` |
| `GITHUB_REPO_OWNER` | ✅ | GitHub 用户名 | `zhangsan` |
| `GITHUB_REPO_NAME` | ✅ | 备份仓库名 | `nezha-backup` |
| `GITHUB_BRANCH` | ✅ | 备份仓库分支 | `main` |
| `ZIP_PASSWORD` | ✅ | 备份压缩密码 | `MySecurePass123` |
| `NZ_UUID` | ✅ | Agent UUID | `550e8400-e29b-...` |
| `NZ_TLS` | ✅ | 是否启用 TLS | `true` |
| `NZ_CLIENT_SECRET` | ✅* | Agent 密钥 | `pXGhxrZl...` |
| `DASHBOARD_VERSION` | ✅ | 面板版本 | `v1.14.1` 不填写默认最新 |

> *`NZ_CLIENT_SECRET` 在第一次备份后添加

---

## 🔑 新手必记重点

> **1. 部署顺序很重要**
> Fork → 构建镜像 → 配置 Tunnel → 创建 Space → 部署 → 备份 → 补填 Secret

> **2. Agent 密钥以备份为准**
> HF 环境变量中，凡是 Agent 相关密钥，**一律以备份仓库中的 `config.yaml` 为准**

> **3. 第一次登录必须改密码**
> 默认密码是公开的，不改等于裸奔

> **4. 定期检查备份**
> 建议定期触发备份，确保数据安全

---

## 十六、后续维护

### 更新面板版本

1. 修改 HF 环境变量中的 `DASHBOARD_VERSION`
2. 重启 Space

### 手动触发备份

1. 修改备份仓库的 README.md 为 `backup`
2. 等待备份完成

### 恢复数据

如果 HF 容器重建：
1. 确保所有环境变量正确（特别是 `NZ_CLIENT_SECRET`）
2. 重启 Space，数据会自动从备份恢复

---

*教程结束，祝你部署顺利！* 🎉
